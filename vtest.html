<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Video Player with HilltopAds VAST</title>
  
</head>
<body>
  <div id="video-wrapper">
    <video id="video-id" poster="https://via.placeholder.com/640x480?text=Loading+Video">
      <source src="/main_Resource/ads/video ads/The_Bread_-_Animated_Short_Film_by_GULU(360p).mp4" type="video/mp4" />
      <!-- Fallback source for testing -->
      <!-- <source src="https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_1mb.mp4" type="video/mp4" /> -->
      Your browser does not support the video tag.
    </video>
    <div id="play-overlay" onclick="document.getElementById('video-id').play(); this.style.display='none';">â–¶ Play Video</div>
  </div>
  
  <script src="https://cdn.fluidplayer.com/v3/current/fluidplayer.min.js"></script>
  <script>
    const video = document.getElementById('video-id');
    let myFP;  // Player instance
    let initialized = false;  // Flag to prevent multiple inits
    let adRetryCount = 0;  // For optional retry on error
    const MAX_RETRIES = 1;  // Retry VAST once on fail
    let logDebounce = {};  // Simple debounce for logs
    const commonLayout = {
      controlBar: {
        autoHideTimeout: 3,
        animated: true,
        autoHide: true
      },
      htmlOnPauseBlock: {
        html: null,
        height: null,
        width: null
      },
      autoPlay: false,
      mute: true,
      allowTheatre: true,
      playPauseAnimation: false,
      playbackRateEnabled: false,
      allowDownload: false,
      playButtonShowing: false,
      fillToContainer: true,
      posterImage: null,
      primaryColor: ""
    };

    // Debounced log function
    function debouncedLog(type, msg) {
      const key = type + Date.now().toString().slice(-5);
      if (!logDebounce[key]) {
        logDebounce[key] = true;
        setTimeout(() => delete logDebounce[key], 1000);
        console.log(msg);
      }
    }

    // Handle metadata loading
    video.addEventListener('loadedmetadata', function() {
      const duration = video.duration;
      debouncedLog('metadata', 'Video duration loaded: ' + duration + ' seconds');
      
      if (duration > 1 && !isNaN(duration) && !initialized) {
        initialized = true;
        console.log('Initializing Fluid Player with HilltopAds VAST (~' + Math.round(duration / 60) + ' min)');
        
        myFP = fluidPlayer('video-id', {
          layoutControls: commonLayout,
          vastOptions: {
            adList: [
              {
                roll: "preRoll",
                // HilltopAds VAST with CORS proxy (activate at https://cors-anywhere.herokuapp.com/ first)
                vastTag: "https://cors-anywhere.herokuapp.com/https://impracticalshoulder.com/dgm.F/zhdJGyNXv-ZaGqUo/ceAmh9OubZlUflFk/PgTbYX2MNNziIF3nMJTtkNtcNIjNYi3sM/j/c/y/MzCcZ/sUabW/1MpUd/D_0FxL",
                // Self-proxy example (uncomment if set up):
                // vastTag: "/vast-proxy.php?url=" + encodeURIComponent("https://impracticalshoulder.com/dgm.F/zhdJGyNXv-ZaGqUo/ceAmh9OubZlUflFk/PgTbYX2MNNziIF3nMJTtkNtcNIjNYi3sM/j/c/y/MzCcZ/sUabW/1MpUd/D_0FxL"),
                // Fallback Google test (uncomment if HilltopAds fails):
                // vastTag: "https://pubads.g.doubleclick.net/gampad/ads?sz=640x480&iu=/124319096/external/single_ad_samples&ciu_szs=300x250&impl=s&gdfp_req=1&env=vp&output=vast&unviewed_position_start=1&cust_params=deployment%3Ddevsite%26sample_ct%3Dskippablelinear&correlator=123",
                adText: ""
              }
            ],
            adCTAText: false,
            adCTATextPosition: "",
            debug: true,
            vastLoadTimeout: 30000,  // 30s for ad networks
            vastLoadFailTimeout: 5000,
            vastRetryAttempts: 2,
            vastVersion: "4.0",
            vastAdUnit: "",
            vastError: true  // Enable detailed error reporting
          }
        });

        // Corrected camelCase VAST events (no [FP_ERROR] now)
        myFP.on('vastAdLoaded', function(e) {
          console.log('HilltopAds VAST XML loaded successfully:', e);
          adRetryCount = 0;
        });
        myFP.on('vastAdError', function(e) {
          console.error('HilltopAds VAST Ad Error Details:', e);
          console.error('Error Code:', e.code || 'Unknown');  // 101/900
          console.error('Error Message:', e.message || 'No message');
          if (e.message && (e.message.toLowerCase().includes('cors') || e.message.toLowerCase().includes('fetch') || e.message.toLowerCase().includes('blocked'))) {
            console.error('Detected CORS Issue - Activate proxy or contact HilltopAds support!');
          }
          console.error('VAST URL Attempted:', e.vastTagUrl || 'Unknown URL');
          if ((e.code === 101 || e.code === 900) && adRetryCount < MAX_RETRIES) {
            adRetryCount++;
            console.log(`Retry ${adRetryCount}/${MAX_RETRIES} - Reinitializing without ads...`);
            setTimeout(() => {
              if (myFP && typeof myFP.destroy === 'function') myFP.destroy();
              myFP = fluidPlayer('video-id', {
                layoutControls: commonLayout,
                vastOptions: { adList: [] }  // No ads
              });
              video.play().catch(err => console.warn('Play after retry:', err));
            }, 1000);
          } else {
            console.log('Max retries reached or non-retryable error - Skipping ads');
          }
          // Resume main video
          setTimeout(() => {
            if (video.paused) {
              video.play().catch(err => console.warn('Resume play after ad error:', err));
            }
          }, 100);
        });
        myFP.on('vastAdImpression', function(e) {
          console.log('HilltopAds Ad impression tracked (ad started):', e);
        });
        myFP.on('vastAdVideoStart', function(e) {
          console.log('HilltopAds Ad video playing');
        });
        myFP.on('vastAdComplete', function(e) {
          console.log('HilltopAds Ad completed - transitioning to main video');
          setTimeout(() => video.play().catch(err => console.warn('Play main video:', err)), 500);
        });
        myFP.on('vastAdSkip', function(e) {
          console.log('HilltopAds Ad skipped by user');
        });
        myFP.on('vastAdClick', function(e) {
          console.log('HilltopAds Ad clicked - tracking URL fired');
        });
        myFP.on('vastAdEnd', function(e) {
          console.log('HilltopAds Ad ended/stopped');
        });
        // Player error (lowercase)
        myFP.on('error', function(e) {
          console.error('Player Error:', e);
        });

        // Show play overlay (check config autoPlay, not video prop)
        const config = { autoPlay: false };  // From commonLayout
        if (!config.autoPlay) {
          document.getElementById('play-overlay').style.display = 'block';
        }
      } else if (duration <= 1 || isNaN(duration)) {
        debouncedLog('invalid', 'Early/invalid duration - waiting for full metadata...');
      }
    });

    video.addEventListener('error', function(e) {
      console.error('Video load error:', e);
      document.getElementById('play-overlay').style.display = 'none';
    });

    video.addEventListener('canplay', function() {
      debouncedLog('canplay', 'Video can play - ready!');
    });

    // Fallback: Init without ads after 30s
    setTimeout(() => {
      if (!initialized) {
        console.log('Fallback: Initializing without ads (metadata timeout)');
        initialized = true;
        myFP = fluidPlayer('video-id', {
          layoutControls: commonLayout,
          vastOptions: { adList: [] }
        });
        setTimeout(() => video.play().catch(err => console.warn('Fallback play:', err)), 500);
      }
    }, 30000);
  </script>
</body>
</html>